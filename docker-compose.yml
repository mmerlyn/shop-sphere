version: '3.8'

services:
  # PostgreSQL for User Service
  postgres-users:
    image: postgres:15-alpine
    container_name: shop-sphere-postgres-users
    environment:
      POSTGRES_DB: users_db
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
    ports:
      - "5432:5432"
    volumes:
      - postgres-users-data:/var/lib/postgresql/data
    networks:
      - shop-sphere-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL for Product Service
  postgres-products:
    image: postgres:15-alpine
    container_name: shop-sphere-postgres-products
    environment:
      POSTGRES_DB: products_db
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
    ports:
      - "5433:5432"
    volumes:
      - postgres-products-data:/var/lib/postgresql/data
    networks:
      - shop-sphere-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL for Order Service
  postgres-orders:
    image: postgres:15-alpine
    container_name: shop-sphere-postgres-orders
    environment:
      POSTGRES_DB: orders_db
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
    ports:
      - "5434:5432"
    volumes:
      - postgres-orders-data:/var/lib/postgresql/data
    networks:
      - shop-sphere-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL for Payment Service
  postgres-payments:
    image: postgres:15-alpine
    container_name: shop-sphere-postgres-payments
    environment:
      POSTGRES_DB: payments_db
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
    ports:
      - "5435:5432"
    volumes:
      - postgres-payments-data:/var/lib/postgresql/data
    networks:
      - shop-sphere-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL for Review Service
  postgres-reviews:
    image: postgres:15-alpine
    container_name: shop-sphere-postgres-reviews
    environment:
      POSTGRES_DB: reviews_db
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
    ports:
      - "5436:5432"
    volumes:
      - postgres-reviews-data:/var/lib/postgresql/data
    networks:
      - shop-sphere-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for Cart Service and Caching
  redis:
    image: redis:7-alpine
    container_name: shop-sphere-redis
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - shop-sphere-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Elasticsearch for Product Search
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: shop-sphere-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    networks:
      - shop-sphere-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Nginx Load Balancer
  nginx:
    image: nginx:1.25-alpine
    container_name: shop-sphere-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - api-gateway-1
      - api-gateway-2
      - api-gateway-3
    networks:
      - shop-sphere-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/nginx-health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # API Gateway replicas for load balancing
  api-gateway-1:
    build:
      context: ./services/api-gateway
      dockerfile: Dockerfile
    container_name: shop-sphere-api-gateway-1
    environment:
      PORT: 8000
      NODE_ENV: production
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      USER_SERVICE_URL: http://user-service:3001
      PRODUCT_SERVICE_URL: http://product-service:3002
      CART_SERVICE_URL: http://cart-service:3003
      ORDER_SERVICE_URL: http://order-service:3004
      NOTIFICATION_SERVICE_URL: http://notification-service:3005
      PAYMENT_SERVICE_URL: http://payment-service:3006
      REVIEW_SERVICE_URL: http://review-service:3007
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - shop-sphere-network

  api-gateway-2:
    build:
      context: ./services/api-gateway
      dockerfile: Dockerfile
    container_name: shop-sphere-api-gateway-2
    environment:
      PORT: 8000
      NODE_ENV: production
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      USER_SERVICE_URL: http://user-service:3001
      PRODUCT_SERVICE_URL: http://product-service:3002
      CART_SERVICE_URL: http://cart-service:3003
      ORDER_SERVICE_URL: http://order-service:3004
      NOTIFICATION_SERVICE_URL: http://notification-service:3005
      PAYMENT_SERVICE_URL: http://payment-service:3006
      REVIEW_SERVICE_URL: http://review-service:3007
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - shop-sphere-network

  api-gateway-3:
    build:
      context: ./services/api-gateway
      dockerfile: Dockerfile
    container_name: shop-sphere-api-gateway-3
    environment:
      PORT: 8000
      NODE_ENV: production
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      USER_SERVICE_URL: http://user-service:3001
      PRODUCT_SERVICE_URL: http://product-service:3002
      CART_SERVICE_URL: http://cart-service:3003
      ORDER_SERVICE_URL: http://order-service:3004
      NOTIFICATION_SERVICE_URL: http://notification-service:3005
      PAYMENT_SERVICE_URL: http://payment-service:3006
      REVIEW_SERVICE_URL: http://review-service:3007
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - shop-sphere-network

  # Microservices
  user-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    container_name: shop-sphere-user-service
    environment:
      PORT: 3001
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres-users:5432/users_db?schema=public
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-your-refresh-secret}
      NOTIFICATION_SERVICE_URL: http://notification-service:3005
      REDIS_HOST: redis
      REDIS_PORT: 6379
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
    depends_on:
      postgres-users:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - shop-sphere-network

  product-service:
    build:
      context: ./services/product-service
      dockerfile: Dockerfile
    container_name: shop-sphere-product-service
    environment:
      PORT: 3002
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres-products:5432/products_db?schema=public
      ELASTICSEARCH_URL: http://elasticsearch:9200
      REDIS_HOST: redis
      REDIS_PORT: 6379
    volumes:
      - ./data:/app/data:ro
    depends_on:
      postgres-products:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - shop-sphere-network

  cart-service:
    build:
      context: ./services/cart-service
      dockerfile: Dockerfile
    container_name: shop-sphere-cart-service
    environment:
      PORT: 3003
      REDIS_HOST: redis
      REDIS_PORT: 6379
      PRODUCT_SERVICE_URL: http://product-service:3002
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - shop-sphere-network

  order-service:
    build:
      context: ./services/order-service
      dockerfile: Dockerfile
    container_name: shop-sphere-order-service
    environment:
      PORT: 3004
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres-orders:5432/orders_db?schema=public
      CART_SERVICE_URL: http://cart-service:3003
      PRODUCT_SERVICE_URL: http://product-service:3002
      USER_SERVICE_URL: http://user-service:3001
      NOTIFICATION_SERVICE_URL: http://notification-service:3005
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
    depends_on:
      postgres-orders:
        condition: service_healthy
    networks:
      - shop-sphere-network

  notification-service:
    build:
      context: ./services/notification-service
      dockerfile: Dockerfile
    container_name: shop-sphere-notification-service
    environment:
      PORT: 3005
      MAIL_HOST: ${MAIL_HOST:-smtp.gmail.com}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USER: ${MAIL_USER:-}
      MAIL_PASSWORD: ${MAIL_PASSWORD:-}
      MAIL_FROM: ${MAIL_FROM:-noreply@shopsphere.com}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
    networks:
      - shop-sphere-network

  payment-service:
    build:
      context: ./services/payment-service
      dockerfile: Dockerfile
    container_name: shop-sphere-payment-service
    environment:
      PORT: 3006
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres-payments:5432/payments_db?schema=public
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      ORDER_SERVICE_URL: http://order-service:3004
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
    depends_on:
      postgres-payments:
        condition: service_healthy
    networks:
      - shop-sphere-network

  review-service:
    build:
      context: ./services/review-service
      dockerfile: Dockerfile
    container_name: shop-sphere-review-service
    environment:
      PORT: 3007
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres-reviews:5432/reviews_db?schema=public
      ORDER_SERVICE_URL: http://order-service:3004
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
    depends_on:
      postgres-reviews:
        condition: service_healthy
    networks:
      - shop-sphere-network

  # PgAdmin for Database Management (Optional)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: shop-sphere-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@shopsphere.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:?PGADMIN_PASSWORD is required}
    ports:
      - "5050:80"
    networks:
      - shop-sphere-network
    depends_on:
      - postgres-users
      - postgres-products
      - postgres-orders
      - postgres-payments
      - postgres-reviews

volumes:
  postgres-users-data:
  postgres-products-data:
  postgres-orders-data:
  postgres-payments-data:
  postgres-reviews-data:
  redis-data:
  elasticsearch-data:

networks:
  shop-sphere-network:
    driver: bridge
